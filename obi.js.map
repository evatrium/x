{"version":3,"file":"obi.js","sources":["src/obi.js"],"sourcesContent":["import {def, extend, isFunc, isObj, Subie} from \"./utils\";\n\nexport const obi = suspect => {\n    const {sub, notify} = Subie();\n    let makeObi = obj => {\n        if (obj.$obi) return obj;\n        def(obj, '$obi', {enumerable: false, value: true});\n        def(obj, '$batching', {enumerable: false, value: {active: false}});\n        def(obj, '$onChange', {enumerable: false, value: update => sub(update)});\n        def(obj, '$getState', {\n            enumerable: false,\n            value: () => Object.keys(obj).reduce((acc, curr) =>\n                !isFunc(obj[curr]) ? (acc[curr] = (isObj(obj[curr]) && obj[curr].$obi)\n                    ? obj[curr].$getState() : obj[curr], acc) : acc, {})\n        });\n        def(obj, '$merge', {\n            enumerable: false,\n            value: (update, ignoreUpdate) => {\n                obj.$batching.active = true;\n                isFunc(update) ? update(suspect) : extend(suspect, update);\n                obj.$batching.active = false;\n                !ignoreUpdate && notify(suspect);\n            }\n        });\n        for (let key in obj) {\n            let internal = obj[key];\n            if (isFunc(internal) || key.startsWith('$')) continue;\n            if (isObj(internal)) internal = makeObi(obj[key]);\n            def(obj, key, {\n                enumerable: true,\n                get: () => internal,\n                set(value) {\n                    if (value === internal) return;\n                    internal = value;\n                    if (!suspect.$batching.active) notify(suspect);\n                },\n            });\n        }\n        return obj\n    };\n    return makeObi(suspect);\n};\n\nexport const obiHOC = (component, obiObj, applyProps) => {\n    let ref, subscribed, unsubscribe, observer,\n        update = () => {\n            setTimeout(() => { // wait a tick till mounted\n                if (subscribed) return;\n                subscribed = true;\n                observer = new MutationObserver(mutationsList => {\n                    if ([...mutationsList[0].removedNodes].includes(ref)) {\n                        observer.disconnect();\n                        unsubscribe();\n                        subscribed = false\n                    }\n                });\n                observer.observe(ref.parentNode, {childList: true});\n                applyProps(ref, obiObj);\n                unsubscribe = obiObj.$onChange((data) => applyProps(ref, data));\n            })\n        };\n    return (props, children) => {\n        update();\n        return component(extend(props, {ref: r => ref = r}), children)\n    }\n};\n"],"names":["obi","suspect","sub","notify","Subie","makeObi","obj","$obi","def","enumerable","value","active","update","Object","keys","reduce","acc","curr","isFunc","isObj","$getState","ignoreUpdate","$batching","extend","key","internal","startsWith","get","set","obiHOC","component","obiObj","applyProps","ref","subscribed","unsubscribe","observer","props","children","setTimeout","MutationObserver","mutationsList","removedNodes","includes","disconnect","observe","parentNode","childList","$onChange","data","r"],"mappings":"qFAEaA,EAAMC,UACTC,IAACA,EAADC,OAAMA,GAAUC,QAClBC,EAAUC,OACNA,EAAIC,KAAM,OAAOD,EACrBE,EAAIF,EAAK,OAAQ,CAACG,YAAY,EAAOC,OAAO,IAC5CF,EAAIF,EAAK,YAAa,CAACG,YAAY,EAAOC,MAAO,CAACC,QAAQ,KAC1DH,EAAIF,EAAK,YAAa,CAACG,YAAY,EAAOC,MAAOE,GAAUV,EAAIU,KAC/DJ,EAAIF,EAAK,YAAa,CAClBG,YAAY,EACZC,MAAO,IAAMG,OAAOC,KAAKR,GAAKS,OAAO,CAACC,EAAKC,IACtCC,EAAOZ,EAAIW,IACoCD,GAD1BA,EAAIC,GAASE,EAAMb,EAAIW,KAAUX,EAAIW,GAAMV,KAC3DD,EAAIW,GAAMG,YAAcd,EAAIW,GAAOD,GAAY,MAE7DR,EAAIF,EAAK,SAAU,CACfG,YAAY,EACZC,MAAO,CAACE,EAAQS,KACZf,EAAIgB,UAAUX,QAAS,EACvBO,EAAON,GAAUA,EAAOX,GAAWsB,EAAOtB,EAASW,GACnDN,EAAIgB,UAAUX,QAAS,GACtBU,GAAgBlB,EAAOF,UAG3B,IAAIuB,KAAOlB,EAAK,KACbmB,EAAWnB,EAAIkB,GACfN,EAAOO,IAAaD,EAAIE,WAAW,OACnCP,EAAMM,KAAWA,EAAWpB,EAAQC,EAAIkB,KAC5ChB,EAAIF,EAAKkB,EAAK,CACVf,YAAY,EACZkB,IAAK,IAAMF,EACXG,IAAIlB,GACIA,IAAUe,IACdA,EAAWf,EACNT,EAAQqB,UAAUX,QAAQR,EAAOF,eAI3CK,UAEJD,EAAQJ,IAGN4B,EAAS,CAACC,EAAWC,EAAQC,SAClCC,EAAKC,EAAYC,EAAaC,QAiB3B,CAACC,EAAOC,KAfPC,WAAW,KACHL,IACJA,GAAa,GACbE,EAAW,IAAII,iBAAiBC,IACxB,IAAIA,EAAc,GAAGC,cAAcC,SAASV,KAC5CG,EAASQ,aACTT,IACAD,GAAa,MAGZW,QAAQZ,EAAIa,WAAY,CAACC,WAAW,IAC7Cf,EAAWC,EAAKF,GAChBI,EAAcJ,EAAOiB,UAAWC,GAASjB,EAAWC,EAAKgB,OAK1DnB,EAAUP,EAAOc,EAAO,CAACJ,IAAKiB,GAAKjB,EAAMiB,IAAKZ"}